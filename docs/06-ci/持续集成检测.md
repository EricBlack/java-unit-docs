# 持续集成检测

## 背景

### 介绍

在单元测试前面的章节介绍过，在本地可以通过 idea 查看单元测试的覆盖率，如果想检测代码质量，可以安装sonarlint 插件，通过插件来分析代码， 但这都局限于在本地通过手动操作，没办法通过一个自动化的平台来给所有研发人员查看。为了解决这个问题，我的方案是，通过 Gitlab-CI + Sonarqube 在每次 commit 代码时做自动检测，检测完成后通过Sonarqube平台来查看代码质量及覆盖率。

## 部署架构图

![](../assets/部署架构图.png)



## 环境、软件安装

由于我的虚拟机系统为 centos7，所以此次环境的搭建基于 centos7。

### docker

1.安装需要的软件包， yum-util 提供 yum-config-manager功能。

```shell
$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2
```

2.设置yum源

```shell
$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
```

3.查看仓库中所有 docker 版本，可选择特定版本安装，这里列举了最新的三个版本。

```shell
$ yum list docker-ce --showduplicates | sort -r
```

|                  |      版本       |                  |
| :--------------: | :-------------: | :--------------: |
| docker-ce.x86_64 | 3:19.03.8-3.el7 | docker-ce-stable |
| docker-ce.x86_64 | 3:19.03.8-3.el7 | docker-ce-stable |
| docker-ce.x86_64 | 3:19.03.7-3.el7 | docker-ce-stable |

说明：版本号为第一个冒号 `:` 开始，直到第一个连字符 `-` 之间的数字字符串。如：19.03.58。

4.安装

```shell
#安装命令 sudo yum install docker-ce-版本号
#这里我选用了最新版本：19.03.58。
$ sudo yum install docker-ce-19.03.58
```

5.启动并加入开机启动

```shell
#启动
$ sudo systemctl start docker
#开机启动
$ sudo systemctl enable docker
```

6.查看docker版本

```shell
$ docker version
```

```
Client: Docker Engine - Community
 Version:           19.03.8
 API version:       1.40
 Go version:        go1.12.17
 Git commit:        afacb8b
 Built:             Wed Mar 11 01:27:04 2020
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.8
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.17
  Git commit:       afacb8b
  Built:            Wed Mar 11 01:25:42 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.13
  GitCommit:        7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc:
  Version:          1.0.0-rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683
```

### docker-compose

1.安装

可以访问 https://github.com/docker/compose/releases/ 自行选择版本。

```shell
$ curl -L https://github.com/docker/compose/releases/download/1.25.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
```

2.授权

```shell
$ chmod +x /usr/local/bin/docker-compose
```

3.查看版本

```shell
$ docker-compose version
```

```
docker-compose version 1.25.4, build 8d51620a
docker-py version: 4.1.0
CPython version: 3.7.5
OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019
```

### Gitlab + Sonarqube

对于 Gitlab + Sonarqube 的安装已给出 docker-compose.yml。将 yml 放入虚拟机执行命令，即可拉取所需镜像并启动容器运行。

说明：最好不要更改镜像版本，不同版本Gitlab 和 Sonarqube 的授权访问是不同的，此处采用的都为教新版本。

```shell
# 运行命令即可拉取所需镜像，并启动容器。
$ docker-compose up
```

Gitlab 访问地址：http://192.168.231.129 ，首次访问时，需设置 root 账号密码。

Sonarqube 访问地址：http://192.168.231.129:9000，默认账号密码为 admin。

#### docker-compose.yml

```yml
version: "3"
services:
  sonarqube:
    image: sonarqube:7.9-community
    container_name: 'sonarqube7.9'
    ports:
      - "9000:9000"
    networks:
      - cinet
    environment:
      - SONARQUBE_JDBC_URL=jdbc:postgresql://db:5432/sonar
  db:
    image: postgres:11.1
    container_name: 'postgres'
    networks:
      - cinet
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: 'gitlab'
    ports:
      - '80:80'
      - '443:443'
      - '220:22'
networks:
  cinet:
    driver: bridge
```

#### 基础配置及插件安装

##### Sonarqube 插件安装



##### Gitlab



### gitlab-runner

由于我使用 docker 安装 runner 时，总不能将镜像下载完全，等了几小时也没有反应，所以此处采用 linux 的安装方式。

说明：gitlab-runner 不要与 gitlab 和 sonarqube 在同一台机器上。





## 授权配置

